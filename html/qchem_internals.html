
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Development Q-Chem &#8212; wiki  documentation</title>
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/classic.css" type="text/css" />
    
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="GROMACS" href="gromacs.html" />
    <link rel="prev" title="How to write in reStructuredText" href="math.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="gromacs.html" title="GROMACS"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="math.html" title="How to write in reStructuredText"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">wiki  documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Development Q-Chem</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="development-q-chem">
<h1>Development Q-Chem<a class="headerlink" href="#development-q-chem" title="Permalink to this headline">¶</a></h1>
<div class="section" id="how-to-add-new-rem-variable">
<h2>How to add new REM variable<a class="headerlink" href="#how-to-add-new-rem-variable" title="Permalink to this headline">¶</a></h2>
<p>REM variables are, in principle, integer only variables. However some
tricks can be done to use them as real.</p>
<p>New REM variables should be defined in file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">config</span><span class="o">/</span><span class="n">rem</span><span class="o">.</span><span class="n">list</span>
</pre></div>
</div>
<p>this file contains the list of all REM variables used in q-chem. Make sure your new
variable does not already exist. Each variable is associated to a number, the range
of numbers available for each user must be reserved in the upper section of the same
file. Make sure to not use more variables than the number of reserved numbers.</p>
<p>Each defined variable should be initializated in file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">libgen</span><span class="o">/</span><span class="n">rem_default</span><span class="o">.</span><span class="n">C</span>
</pre></div>
</div>
<p>The way to initalize a variable is by writting a line as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rem_write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">NAME_OF_VARIABLE</span><span class="p">);</span>
</pre></div>
</div>
<p>where 0 is the initial value(integer).</p>
<p>To use REM variables as real, the variable should be define as <span class="math notranslate nohighlight">\(10^n\)</span> times the
intended value, where <em>n</em> is the maximum number of decimal places of accepted real.
This is defined in <strong>RemDoubleToValue</strong> function placed in file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">qparser</span><span class="o">/</span><span class="n">read_rem</span><span class="o">.</span><span class="n">C</span>
</pre></div>
</div>
<p>which should be edited to add the variable definition like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">Loc</span> <span class="o">==</span> <span class="n">NAME_OF_VARIABLE</span><span class="p">){</span>
  <span class="n">double</span> <span class="n">dVal</span> <span class="o">=</span> <span class="n">TL</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">GetDouble</span><span class="p">();</span>
  <span class="n">Val</span> <span class="o">=</span> <span class="n">INTEGER</span><span class="p">(</span><span class="n">dVal</span><span class="o">*</span><span class="mi">10000</span><span class="p">);</span>
  <span class="n">OK</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Then, within your code, in order to recover the intended real number the REM variable
should be divided by <span class="math notranslate nohighlight">\(10^n\)</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">myrealvariable</span> <span class="o">=</span> <span class="n">rem_read</span><span class="p">(</span><span class="n">NAME_OF_VARIABLE</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10000</span>
</pre></div>
</div>
</div>
<div class="section" id="how-to-add-new-scratch-file">
<h2>How to add new scratch FILE<a class="headerlink" href="#how-to-add-new-scratch-file" title="Permalink to this headline">¶</a></h2>
<p>scratch files are store momory that can be used globally along q-chem code. These files
are intended to be used to store large matrices (avoiding to have them in RAM) but are
also useful to access data from different parts of the code.</p>
<p>This files are defined in</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">include</span><span class="o">/</span><span class="n">fileman</span><span class="o">.</span><span class="n">h</span>
</pre></div>
</div>
<p>where a positive integer number must be assigned to each file. Be careful to not set a
number already in use.</p>
</div>
<div class="section" id="manage-scratch-files">
<h2>Manage scratch files<a class="headerlink" href="#manage-scratch-files" title="Permalink to this headline">¶</a></h2>
<p><strong>FileMan</strong> function manages the scratch data stored in files. They are useful to store large
arrays in one section of the code to be used in another part.</p>
<p>Before using a file it has to be defined in <em>include/fileman.h</em>. This file contains a list of
all files defined along Q-Chem where each one is associated to a number. This number has to be
unique and is more or less taken in a first come first served basis. In order to organize this file
a little, developers usually reserve some range of numbers for themselves by writing a short
comment.</p>
<div class="section" id="opening-file">
<h3>Opening file<a class="headerlink" href="#opening-file" title="Permalink to this headline">¶</a></h3>
<p>To read/store data the file first should be opened</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Open to write data</span>
<span class="n">FileMan</span><span class="p">(</span><span class="n">FM_OPEN_W</span><span class="p">,</span> <span class="n">FILE_NAME</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="c1"># Open to read data</span>
<span class="n">FileMan</span><span class="p">(</span><span class="n">FM_OPEN_R</span><span class="p">,</span> <span class="n">FILE_NAME</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</pre></div>
</div>
<p>where <strong>FM_OPEN_R</strong>/<strong>FM_OPEN_W</strong> labels indicate the type. These labels are already defined in Q-Chem
and are available everywhere. <strong>FILE_NAME</strong> is the name of the file defined in <em>fileman.h</em> file.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It is interesting to be noted that all these labels are just variables that contain integer numbers
defined in the internals of Q-Chem. Its probably done this way for interoperability C/Fortran.</p>
</div>
</div>
<div class="section" id="writing-data">
<h3>Writing data<a class="headerlink" href="#writing-data" title="Permalink to this headline">¶</a></h3>
<p>To store data in the file</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">double</span> <span class="n">data</span><span class="p">[</span><span class="n">N</span><span class="p">];</span>
<span class="n">FileMan</span><span class="p">(</span><span class="n">FM_WRITE</span><span class="p">,</span><span class="n">FILE_NAME</span><span class="p">,</span><span class="n">FM_DP</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">FM_BEG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
</pre></div>
</div>
<p>where <strong>FM_WRITE</strong> labels indicates that the data will be written, <strong>FM_DP</strong> label indicates the data type
(double), <strong>FM_BEG</strong> indicates that the data will be stored from the beginning of the file and <strong>data</strong> is
the array of data to be stored.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Note that <em>data</em> argument should be passed to <em>FileMan</em> as a memory address.</p>
</div>
</div>
<div class="section" id="reading-data">
<h3>Reading data<a class="headerlink" href="#reading-data" title="Permalink to this headline">¶</a></h3>
<p>To determine the length of the array</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">N</span><span class="p">;</span>
<span class="n">FileMan</span><span class="p">(</span><span class="n">FM_GET_LEN</span><span class="p">,</span><span class="n">FILE_NAME</span><span class="p">,</span><span class="n">FM_INT</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">&amp;</span><span class="n">N</span><span class="p">);</span>
</pre></div>
</div>
<p>where <strong>FM_GET_LEN</strong> indicates that the length will be retrieved, <strong>FM_INT</strong> indicates the data type
(integer in this case) and <strong>N</strong> is the variable that will contain the array length.</p>
<p>To read the data form file</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">double</span> <span class="n">data</span><span class="p">[</span><span class="n">N</span><span class="p">];</span>
<span class="n">FileMan</span><span class="p">(</span><span class="n">FM_READ</span><span class="p">,</span><span class="n">FILE_NAME</span><span class="p">,</span><span class="n">FM_DP</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">FM_BEG</span><span class="p">,</span><span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
</pre></div>
</div>
<p>where <strong>FM_READ</strong> indicated reading mode, and <strong>N</strong> is the length of the array.</p>
</div>
<div class="section" id="closing-file">
<h3>Closing file<a class="headerlink" href="#closing-file" title="Permalink to this headline">¶</a></h3>
<p>Once the data is read/written the file should be close by</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FileMan</span><span class="p">(</span><span class="n">FM_CLOSE</span><span class="p">,</span> <span class="n">FILE_NAME</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="final-notes">
<h3>Final notes<a class="headerlink" href="#final-notes" title="Permalink to this headline">¶</a></h3>
<p>When working with armadillo objects (matrices &amp; vectors) the raw data can be accessed
by the methods <em>.begin()</em> &amp; <em>.memptr</em>. This exposes the memory address which allows
to use FileMan directly on these arrays. The difference between this methods is that <em>.memptr</em>
is read only, so it is safer than <em>.begin()</em> if the data have only to be read from the array</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">arma</span><span class="p">::</span><span class="n">Col</span><span class="o">&lt;</span><span class="n">double</span><span class="o">&gt;</span> <span class="n">data_array</span><span class="p">(</span><span class="n">N</span><span class="p">);</span>

<span class="n">FileMan</span><span class="p">(</span><span class="n">FM_WRITE</span><span class="p">,</span><span class="n">FILE_NAME</span><span class="p">,</span><span class="n">FM_DP</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">FM_BEG</span><span class="p">,</span><span class="n">data_array</span><span class="o">.</span><span class="n">begin</span><span class="p">());</span>
<span class="n">FileMan</span><span class="p">(</span><span class="n">FM_READ</span><span class="p">,</span><span class="n">FILE_NAME</span><span class="p">,</span><span class="n">FM_DP</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">FM_BEG</span><span class="p">,</span><span class="n">data_array</span><span class="o">.</span><span class="n">memptr</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="memory-info-inquisition">
<h2>Memory info inquisition<a class="headerlink" href="#memory-info-inquisition" title="Permalink to this headline">¶</a></h2>
<p>To obtain the amount of (static) memory available in mega-array use function:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">available_mem</span> <span class="o">=</span> <span class="n">MegLen</span><span class="p">()</span>
</pre></div>
</div>
<p>this returns the memory in Qwords (blocks of 8 bytes). To transform to megabytes (MB)
(like in Q-Chem the input) units you can use something like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">available_mem</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">MegLen</span><span class="p">())</span><span class="o">/</span><span class="p">(</span><span class="mi">125</span><span class="o">*</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
<p>or alternatively to transform it to mebibytes (MiB) which is common in UNIX based systems use</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">available_mem</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">MegLen</span><span class="p">())</span><span class="o">/</span><span class="p">(</span><span class="mi">128</span><span class="o">*</span><span class="mi">1024</span><span class="p">)</span>
</pre></div>
</div>
<p>The total static memory of the mega-array in the same units can be obtained using the keyword:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">total_mem</span> <span class="o">=</span> <span class="n">MegTot</span><span class="p">()</span>
<span class="n">total_mem</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">MegTot</span><span class="p">())</span><span class="o">/</span><span class="p">(</span><span class="mi">125</span><span class="o">*</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
<p>which corresponds to the requested static memory in the Q-Chem input contained in the REM variable (in MB):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rem_read</span><span class="p">(</span><span class="n">REM_MEM_STATIC</span><span class="p">)</span>
</pre></div>
</div>
<p>The total requested memory (static + dynamic) for the calculation in MB is found in the REM variable:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rem_read</span><span class="p">(</span><span class="n">REM_MEM_TOTAL</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="adding-new-dft-functionals">
<h2>Adding new DFT functionals<a class="headerlink" href="#adding-new-dft-functionals" title="Permalink to this headline">¶</a></h2>
<p>The files containing the main functions of the functional are placed in either:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">*</span><span class="n">libfunc</span><span class="o">*</span> <span class="ow">or</span> <span class="o">*</span><span class="n">libdft</span><span class="o">/</span><span class="n">libfunc</span><span class="o">*</span>
</pre></div>
</div>
<p>To be callable everywhere these functions should be included in</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">include</span><span class="o">/</span><span class="n">extref</span><span class="o">.</span><span class="n">list</span>
</pre></div>
</div>
<p>The C functions prototypes are written in the header</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">libdft</span><span class="o">/</span><span class="n">libdft</span><span class="o">.</span><span class="n">h</span>
</pre></div>
</div>
<p>The definition of components of the functional (evaluations, derivatives, 2nd deribatives)
are writen here</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">libdft</span><span class="o">/</span><span class="n">evalxc</span><span class="o">.</span><span class="n">C</span>
</pre></div>
</div>
<p>The connection with the Q-Chem input interface is defined here</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">libdft</span><span class="o">/</span><span class="n">Functionals</span><span class="o">.</span><span class="n">C</span>
<span class="n">libdft</span><span class="o">/</span><span class="n">dftcodes</span><span class="o">.</span><span class="n">C</span>
</pre></div>
</div>
</div>
<div class="section" id="basis-in-tests">
<h2>Basis in tests<a class="headerlink" href="#basis-in-tests" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">1</span> <span class="mi">3</span> <span class="mi">3</span> <span class="mi">3</span>  <span class="c1"># number of atoms, lines in block 1, lines in block 2, number of function blocks</span>

  <span class="mf">0.0</span> <span class="mf">0.0</span> <span class="mf">0.0</span>   <span class="c1"># coordinates x y z of atom 1</span>

  <span class="c1"># bock 1 (exponents)</span>
  <span class="mf">1.61277758800000e-01</span>
  <span class="mf">7.27000000000000e-01</span>
  <span class="mf">1.05700000000000e+00</span>

  <span class="c1"># block 2</span>
  <span class="mf">1.81380649178652e-01</span>
  <span class="mf">9.56881375059566e-01</span>
  <span class="mf">1.81359656261779e+00</span>

<span class="c1"># function blocks</span>
<span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">1</span> <span class="mi">1</span>   <span class="c1"># atom center, unknown, unknown, starting coeff block 1, num coeff block 1, unknown, unknown</span>
<span class="mi">0</span> <span class="mi">0</span>             <span class="c1"># starting coeff in block 2, num coeff block 2</span>
<span class="mi">1</span> <span class="mi">0</span>             <span class="c1"># function type (0: s, 1:p, 2:d ..), type (0: Cartesian, 1:pure)</span>

<span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">1</span> <span class="mi">3</span> <span class="mi">3</span>
<span class="mi">1</span> <span class="mi">1</span>
<span class="mi">1</span> <span class="mi">0</span>

<span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">2</span> <span class="mi">1</span> <span class="mi">5</span> <span class="mi">6</span>
<span class="mi">2</span> <span class="mi">2</span>
<span class="mi">1</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
<div class="section" id="angular-momentum">
<h2>Angular Momentum<a class="headerlink" href="#angular-momentum" title="Permalink to this headline">¶</a></h2>
<p>Calling angular momentum:</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="kt">REAL</span><span class="o">*</span><span class="mi">8</span>  <span class="n">Lx</span><span class="p">(</span><span class="n">NBas</span><span class="p">,</span> <span class="n">NBas</span><span class="p">),</span> <span class="n">Ly</span><span class="p">(</span><span class="n">NBas</span><span class="p">,</span> <span class="n">NBas</span><span class="p">),</span> <span class="n">Lz</span><span class="p">(</span><span class="n">NBas</span><span class="p">,</span> <span class="n">NBas</span><span class="p">)</span> <span class="c">! Angmom matrices (output)</span>
<span class="kt">REAL</span><span class="o">*</span><span class="mi">8</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">cz</span>  <span class="c">! Center coordinates (input)</span>

<span class="k">CALL </span><span class="n">angmom_mat</span><span class="p">(</span><span class="n">Lx</span><span class="p">,</span> <span class="n">Ly</span><span class="p">,</span> <span class="n">Lz</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">cz</span><span class="p">)</span>

<span class="k">write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Lx&#39;</span>
<span class="k">DO </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">NBas</span>
    <span class="k">write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">Lx</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">),</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">NBas</span><span class="p">)</span>
<span class="n">ENDDO</span>

<span class="k">write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Ly&#39;</span>
<span class="k">DO </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NBas</span>
    <span class="k">write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">Ly</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">),</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">NBas</span><span class="p">)</span>
<span class="n">ENDDO</span>

<span class="k">write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Lz&#39;</span>
<span class="k">DO </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NBas</span>
    <span class="k">write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">Lz</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">),</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">NBas</span><span class="p">)</span>
<span class="n">ENDDO</span>
</pre></div>
</div>
</div>
<div class="section" id="other">
<h2>Other<a class="headerlink" href="#other" title="Permalink to this headline">¶</a></h2>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">extern</span> <span class="s">&quot;C&quot;</span> <span class="kt">void</span> <span class="n">ras_test_</span><span class="p">()</span> <span class="p">{</span>

    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; ----- STARTING TEST -----&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="k">using</span> <span class="n">libqints</span><span class="o">::</span><span class="n">qchem</span><span class="o">::</span><span class="n">aobasis</span><span class="p">;</span>

    <span class="n">INTEGER</span> <span class="n">bCode</span>   <span class="o">=</span> <span class="n">rem_read</span><span class="p">(</span><span class="n">REM_IBASIS</span><span class="p">);</span>
    <span class="n">BasisSet</span> <span class="nf">s1</span><span class="p">(</span><span class="n">bCode</span><span class="p">);</span>
    <span class="n">OneEMtrx</span> <span class="nf">oneE</span><span class="p">(</span><span class="n">bCode</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">NBas</span>   <span class="o">=</span> <span class="n">s1</span><span class="p">.</span><span class="n">getNBasis</span><span class="p">();</span>
    <span class="n">s1</span><span class="p">.</span><span class="n">PrintInfo</span><span class="p">();</span>
    <span class="kt">int</span> <span class="n">NOrb</span>   <span class="o">=</span> <span class="n">oneE</span><span class="p">.</span><span class="n">getNOrb</span><span class="p">();</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;NOrb/NBas:&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">NOrb</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;/&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">NBas</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>


    <span class="n">RasCIStates</span> <span class="n">ras</span><span class="p">;</span>

    <span class="kt">double</span> <span class="n">energy_j</span><span class="p">,</span> <span class="n">energy_k</span><span class="p">,</span> <span class="n">energy_h</span><span class="p">;</span>
    <span class="kt">double</span> <span class="n">energy_n</span> <span class="o">=</span> <span class="n">GeometryData</span><span class="p">().</span><span class="n">get_nuclear_repulsion</span><span class="p">();</span>

    <span class="n">DensityMatrix</span> <span class="n">canonic</span><span class="p">;</span>
    <span class="n">energy_j</span> <span class="o">=</span> <span class="n">CoulombMatrix</span><span class="p">(</span><span class="n">canonic</span><span class="p">).</span><span class="n">get_full_contraction</span><span class="p">(</span><span class="n">canonic</span><span class="p">);</span>
    <span class="n">energy_k</span> <span class="o">=</span> <span class="n">ExchangeMatrix</span><span class="p">(</span><span class="n">canonic</span><span class="p">).</span><span class="n">get_full_contraction</span><span class="p">(</span><span class="n">canonic</span><span class="p">);</span>
    <span class="n">energy_h</span> <span class="o">=</span> <span class="n">HCoreMatrix</span><span class="p">().</span><span class="n">get_full_contraction</span><span class="p">(</span><span class="n">canonic</span><span class="p">);</span>


    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;J: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">energy_j</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;K: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">energy_k</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;/&quot;</span> <span class="o">&lt;&lt;</span> <span class="mf">-0.5</span> <span class="o">*</span> <span class="n">energy_k</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;H: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">energy_h</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>

    <span class="kt">double</span> <span class="n">tot_energy2</span> <span class="o">=</span> <span class="n">energy_j</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">energy_k</span> <span class="o">+</span> <span class="n">energy_h</span> <span class="o">+</span> <span class="n">energy_n</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Total energy: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">tot_energy2</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">CoulombMatrix</span><span class="p">(</span><span class="n">canonic</span><span class="p">).</span><span class="n">get_matrix_ao</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>

    <span class="n">energy_j</span> <span class="o">=</span> <span class="n">CoulombMatrix2</span><span class="p">(</span><span class="n">canonic</span><span class="p">).</span><span class="n">get_full_contraction</span><span class="p">(</span><span class="n">canonic</span><span class="p">);</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;J2: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">energy_j</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">CoulombMatrix2</span><span class="p">(</span><span class="n">canonic</span><span class="p">).</span><span class="n">get_matrix_ao</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>

    <span class="n">energy_k</span> <span class="o">=</span> <span class="n">ExchangeMatrix2</span><span class="p">(</span><span class="n">canonic</span><span class="p">).</span><span class="n">get_full_contraction</span><span class="p">(</span><span class="n">canonic</span><span class="p">);</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;K2: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">energy_k</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;/&quot;</span> <span class="o">&lt;&lt;</span> <span class="mf">-0.5</span> <span class="o">*</span> <span class="n">energy_k</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>

    <span class="k">return</span><span class="p">;</span>

    <span class="c1">//  Set up memory and threading (also only need to be done once)</span>
    <span class="n">libqints</span><span class="o">::</span><span class="n">dev_omp</span> <span class="n">qints_dev</span><span class="p">;</span>
    <span class="n">qints_dev</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="mi">8UL</span> <span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">);</span>

    <span class="kt">int</span> <span class="n">NBasis</span>   <span class="o">=</span> <span class="n">bSetMgr</span><span class="p">.</span><span class="n">crntShlsStats</span><span class="p">(</span><span class="n">STAT_NBASIS</span><span class="p">);</span>

    <span class="c1">//int NBasis = b1.get_nbsf();</span>

    <span class="c1">// These should be initialized properly before creating arrays below</span>
    <span class="n">arma</span><span class="o">::</span><span class="n">mat</span> <span class="n">J</span><span class="p">(</span><span class="n">NBasis</span><span class="p">,</span> <span class="n">NBasis</span><span class="p">),</span> <span class="n">K</span><span class="p">(</span><span class="n">NBasis</span><span class="p">,</span> <span class="n">NBasis</span><span class="p">);</span>
    <span class="n">arma</span><span class="o">::</span><span class="n">mat</span> <span class="n">Ja</span><span class="p">(</span><span class="n">NBasis</span><span class="p">,</span> <span class="n">NBasis</span><span class="p">),</span> <span class="n">Ka</span><span class="p">(</span><span class="n">NBasis</span><span class="p">,</span> <span class="n">NBasis</span><span class="p">);</span>
    <span class="n">arma</span><span class="o">::</span><span class="n">mat</span> <span class="n">Jb</span><span class="p">(</span><span class="n">NBasis</span><span class="p">,</span> <span class="n">NBasis</span><span class="p">),</span> <span class="n">Kb</span><span class="p">(</span><span class="n">NBasis</span><span class="p">,</span> <span class="n">NBasis</span><span class="p">);</span>

    <span class="n">arma</span><span class="o">::</span><span class="n">mat</span> <span class="n">P</span> <span class="o">=</span> <span class="n">arma</span><span class="o">::</span><span class="n">eye</span><span class="p">(</span><span class="n">NBasis</span><span class="p">,</span> <span class="n">NBasis</span><span class="p">);</span>
    <span class="n">arma</span><span class="o">::</span><span class="n">mat</span> <span class="n">Pa</span> <span class="o">=</span> <span class="n">arma</span><span class="o">::</span><span class="n">eye</span><span class="p">(</span><span class="n">NBasis</span><span class="p">,</span> <span class="n">NBasis</span><span class="p">);</span>
    <span class="n">arma</span><span class="o">::</span><span class="n">mat</span> <span class="n">Pb</span> <span class="o">=</span> <span class="n">arma</span><span class="o">::</span><span class="n">eye</span><span class="p">(</span><span class="n">NBasis</span><span class="p">,</span> <span class="n">NBasis</span><span class="p">);</span>

    <span class="n">P</span> <span class="o">=</span> <span class="n">canonic</span><span class="p">.</span><span class="n">get_matrix_ao</span><span class="p">();</span>
    <span class="n">Pa</span> <span class="o">=</span> <span class="n">canonic</span><span class="p">.</span><span class="n">get_matrix_ao_alpha</span><span class="p">();</span>
    <span class="n">Pb</span> <span class="o">=</span> <span class="n">canonic</span><span class="p">.</span><span class="n">get_matrix_ao_beta</span><span class="p">();</span>


    <span class="c1">//P(1, 1) = -1;</span>

    <span class="c1">//  Reorder density matrix in-place for libqints ordering of basis functions</span>
    <span class="n">libqints</span><span class="o">::</span><span class="n">gto</span><span class="o">::</span><span class="n">reorder_cc</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">aobasis</span><span class="p">.</span><span class="n">b1</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">libqints</span><span class="o">::</span><span class="n">gto</span><span class="o">::</span><span class="n">korder</span><span class="p">,</span> <span class="n">libqints</span><span class="o">::</span><span class="n">gto</span><span class="o">::</span><span class="n">lex</span><span class="p">);</span>
    <span class="n">libqints</span><span class="o">::</span><span class="n">gto</span><span class="o">::</span><span class="n">reorder_cc</span><span class="p">(</span><span class="n">Pa</span><span class="p">,</span> <span class="n">aobasis</span><span class="p">.</span><span class="n">b1</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">libqints</span><span class="o">::</span><span class="n">gto</span><span class="o">::</span><span class="n">korder</span><span class="p">,</span> <span class="n">libqints</span><span class="o">::</span><span class="n">gto</span><span class="o">::</span><span class="n">lex</span><span class="p">);</span>
    <span class="n">libqints</span><span class="o">::</span><span class="n">gto</span><span class="o">::</span><span class="n">reorder_cc</span><span class="p">(</span><span class="n">Pb</span><span class="p">,</span> <span class="n">aobasis</span><span class="p">.</span><span class="n">b1</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">libqints</span><span class="o">::</span><span class="n">gto</span><span class="o">::</span><span class="n">korder</span><span class="p">,</span> <span class="n">libqints</span><span class="o">::</span><span class="n">gto</span><span class="o">::</span><span class="n">lex</span><span class="p">);</span>

    <span class="c1">//  Density matrix array (input)</span>
    <span class="n">libqints</span><span class="o">::</span><span class="n">array_view</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">av_p</span><span class="p">(</span><span class="n">P</span><span class="p">.</span><span class="n">memptr</span><span class="p">(),</span> <span class="n">NBasis</span><span class="o">*</span><span class="n">NBasis</span><span class="p">);</span>
    <span class="n">libqints</span><span class="o">::</span><span class="n">array_view</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">av_Pa</span><span class="p">(</span><span class="n">Pa</span><span class="p">.</span><span class="n">memptr</span><span class="p">(),</span> <span class="n">NBasis</span><span class="o">*</span><span class="n">NBasis</span><span class="p">);</span>
    <span class="n">libqints</span><span class="o">::</span><span class="n">array_view</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">av_Pb</span><span class="p">(</span><span class="n">Pb</span><span class="p">.</span><span class="n">memptr</span><span class="p">(),</span> <span class="n">NBasis</span><span class="o">*</span><span class="n">NBasis</span><span class="p">);</span>

    <span class="c1">//  J matrix array (output)</span>
    <span class="n">libqints</span><span class="o">::</span><span class="n">array_view</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">av_j</span><span class="p">(</span><span class="n">J</span><span class="p">.</span><span class="n">memptr</span><span class="p">(),</span> <span class="n">NBasis</span><span class="o">*</span><span class="n">NBasis</span><span class="p">);</span>
    <span class="n">libqints</span><span class="o">::</span><span class="n">array_view</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">av_Ja</span><span class="p">(</span><span class="n">Ja</span><span class="p">.</span><span class="n">memptr</span><span class="p">(),</span> <span class="n">NBasis</span><span class="o">*</span><span class="n">NBasis</span><span class="p">);</span>
    <span class="n">libqints</span><span class="o">::</span><span class="n">array_view</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">av_Jb</span><span class="p">(</span><span class="n">Jb</span><span class="p">.</span><span class="n">memptr</span><span class="p">(),</span> <span class="n">NBasis</span><span class="o">*</span><span class="n">NBasis</span><span class="p">);</span>

    <span class="c1">//  K matrix array (output)</span>
    <span class="n">libqints</span><span class="o">::</span><span class="n">array_view</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">av_k</span><span class="p">(</span><span class="n">K</span><span class="p">.</span><span class="n">memptr</span><span class="p">(),</span> <span class="n">NBasis</span><span class="o">*</span><span class="n">NBasis</span><span class="p">);</span>
    <span class="n">libqints</span><span class="o">::</span><span class="n">array_view</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">av_Ka</span><span class="p">(</span><span class="n">Ka</span><span class="p">.</span><span class="n">memptr</span><span class="p">(),</span> <span class="n">NBasis</span><span class="o">*</span><span class="n">NBasis</span><span class="p">);</span>
    <span class="n">libqints</span><span class="o">::</span><span class="n">array_view</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">av_Kb</span><span class="p">(</span><span class="n">Kb</span><span class="p">.</span><span class="n">memptr</span><span class="p">(),</span> <span class="n">NBasis</span><span class="o">*</span><span class="n">NBasis</span><span class="p">);</span>

    <span class="kt">int</span> <span class="n">justAlTemp</span> <span class="o">=</span> <span class="n">rem_read</span><span class="p">(</span><span class="n">REM_JUSTAL</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">spinTemp</span> <span class="o">=</span> <span class="n">rem_read</span><span class="p">(</span><span class="n">REM_SET_SPIN</span><span class="p">);</span>
    <span class="c1">//rem_write(1,REM_JUSTAL);</span>
    <span class="c1">//rem_write(1,REM_SET_SPIN);</span>

    <span class="c1">//  Run the JK-build job</span>
    <span class="n">libqints</span><span class="o">::</span><span class="n">op_coulomb</span> <span class="n">op</span><span class="p">;</span>
    <span class="n">libfock</span><span class="o">::</span><span class="n">jk_engine</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">aobasis</span><span class="p">.</span><span class="n">b4</span><span class="p">,</span> <span class="n">qints_dev</span><span class="p">).</span><span class="n">compute</span><span class="p">(</span><span class="n">av_p</span><span class="p">,</span> <span class="n">av_j</span><span class="p">,</span> <span class="n">av_k</span><span class="p">);</span>
    <span class="n">libfock</span><span class="o">::</span><span class="n">jk_engine</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">aobasis</span><span class="p">.</span><span class="n">b4</span><span class="p">,</span> <span class="n">qints_dev</span><span class="p">).</span><span class="n">compute</span><span class="p">(</span><span class="n">av_Pa</span><span class="p">,</span> <span class="n">av_Pb</span><span class="p">,</span> <span class="n">av_Ja</span><span class="p">,</span> <span class="n">av_Jb</span><span class="p">,</span> <span class="n">av_Ka</span><span class="p">,</span> <span class="n">av_Kb</span><span class="p">);</span>


    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Orbitals&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">canonic</span><span class="p">.</span><span class="n">get_matrix_ao_alpha</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">canonic</span><span class="p">.</span><span class="n">get_matrix_ao_beta</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">canonic</span><span class="p">.</span><span class="n">get_matrix_mo_alpha</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">canonic</span><span class="p">.</span><span class="n">get_matrix_mo_beta</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">canonic</span><span class="p">.</span><span class="n">get_matrix_mo</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>


    <span class="n">libqints</span><span class="o">::</span><span class="n">gto</span><span class="o">::</span><span class="n">reorder_cc</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">aobasis</span><span class="p">.</span><span class="n">b1</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">libqints</span><span class="o">::</span><span class="n">gto</span><span class="o">::</span><span class="n">lex</span><span class="p">,</span> <span class="n">libqints</span><span class="o">::</span><span class="n">gto</span><span class="o">::</span><span class="n">korder</span><span class="p">);</span>
    <span class="n">libqints</span><span class="o">::</span><span class="n">gto</span><span class="o">::</span><span class="n">reorder_cc</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="n">aobasis</span><span class="p">.</span><span class="n">b1</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">libqints</span><span class="o">::</span><span class="n">gto</span><span class="o">::</span><span class="n">lex</span><span class="p">,</span> <span class="n">libqints</span><span class="o">::</span><span class="n">gto</span><span class="o">::</span><span class="n">korder</span><span class="p">);</span>
    <span class="n">libqints</span><span class="o">::</span><span class="n">gto</span><span class="o">::</span><span class="n">reorder_cc</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">aobasis</span><span class="p">.</span><span class="n">b1</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">libqints</span><span class="o">::</span><span class="n">gto</span><span class="o">::</span><span class="n">lex</span><span class="p">,</span> <span class="n">libqints</span><span class="o">::</span><span class="n">gto</span><span class="o">::</span><span class="n">korder</span><span class="p">);</span>

    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;P&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">P</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;J&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">J</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;K&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">K</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Jtot(full): &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">arma</span><span class="o">::</span><span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">J</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Ja: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">arma</span><span class="o">::</span><span class="n">dot</span><span class="p">(</span><span class="n">Pa</span><span class="p">,</span> <span class="n">Ja</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Jb: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">arma</span><span class="o">::</span><span class="n">dot</span><span class="p">(</span><span class="n">Pb</span><span class="p">,</span> <span class="n">Jb</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Jtot: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">arma</span><span class="o">::</span><span class="n">dot</span><span class="p">(</span><span class="n">Pa</span><span class="p">,</span> <span class="n">Ja</span><span class="p">)</span> <span class="o">+</span> <span class="n">arma</span><span class="o">::</span><span class="n">dot</span><span class="p">(</span><span class="n">Pb</span><span class="p">,</span> <span class="n">Jb</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Ktot: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">arma</span><span class="o">::</span><span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Ka: &quot;</span> <span class="o">&lt;&lt;</span> <span class="mf">-0.5</span> <span class="o">*</span> <span class="n">arma</span><span class="o">::</span><span class="n">dot</span><span class="p">(</span><span class="n">Pa</span><span class="p">,</span> <span class="n">Ka</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Kb: &quot;</span> <span class="o">&lt;&lt;</span> <span class="mf">-0.5</span> <span class="o">*</span> <span class="n">arma</span><span class="o">::</span><span class="n">dot</span><span class="p">(</span><span class="n">Pb</span><span class="p">,</span> <span class="n">Kb</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="c1">//std::cout &lt;&lt; &quot;Ktot: &quot; &lt;&lt; arma::dot(Pa, Ka) + arma::dot(Pb, Kb) &lt;&lt; std::endl;</span>

    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;H: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">energy_h</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;nuc: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">energy_n</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>

    <span class="kt">double</span> <span class="n">tot_energy3</span> <span class="o">=</span> <span class="n">arma</span><span class="o">::</span><span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">J</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">arma</span><span class="o">::</span><span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">energy_h</span> <span class="o">+</span> <span class="n">energy_n</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Total energy: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">tot_energy3</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="kt">double</span> <span class="n">tot_energy4</span> <span class="o">=</span> <span class="n">arma</span><span class="o">::</span><span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">J</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">arma</span><span class="o">::</span><span class="n">dot</span><span class="p">(</span><span class="n">Pa</span><span class="p">,</span> <span class="n">Ka</span><span class="p">)</span> <span class="o">+</span> <span class="n">arma</span><span class="o">::</span><span class="n">dot</span><span class="p">(</span><span class="n">Pb</span><span class="p">,</span> <span class="n">Kb</span><span class="p">))</span> <span class="o">+</span> <span class="n">energy_h</span> <span class="o">+</span> <span class="n">energy_n</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Total energy(f): &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">tot_energy4</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>


    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">Lx</span><span class="p">(</span><span class="n">NBasis</span> <span class="o">*</span> <span class="n">NBasis</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">Ly</span><span class="p">(</span><span class="n">NBasis</span> <span class="o">*</span> <span class="n">NBasis</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">Lz</span><span class="p">(</span><span class="n">NBasis</span> <span class="o">*</span> <span class="n">NBasis</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>
    <span class="n">libqints</span><span class="o">::</span><span class="n">array_view</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">av_Lx</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Lx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Lx</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
    <span class="n">libqints</span><span class="o">::</span><span class="n">array_view</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">av_Ly</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Ly</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Ly</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
    <span class="n">libqints</span><span class="o">::</span><span class="n">array_view</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">av_Lz</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Lz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Lz</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
    <span class="n">libqints</span><span class="o">::</span><span class="n">multi_array</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">ma_L</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
    <span class="n">ma_L</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">av_Lx</span><span class="p">);</span>
    <span class="n">ma_L</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">av_Ly</span><span class="p">);</span>
    <span class="n">ma_L</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">av_Lz</span><span class="p">);</span>

    <span class="kt">double</span> <span class="n">cx</span> <span class="o">=</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">rand</span><span class="p">()</span> <span class="o">%</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="mf">500.0</span> <span class="o">*</span><span class="mf">0.0</span><span class="p">;</span>
    <span class="kt">double</span> <span class="n">cy</span> <span class="o">=</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">rand</span><span class="p">()</span> <span class="o">%</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="mf">500.0</span> <span class="o">*</span><span class="mf">0.0</span><span class="p">;</span>
    <span class="kt">double</span> <span class="n">cz</span> <span class="o">=</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">rand</span><span class="p">()</span> <span class="o">%</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="mf">500.0</span> <span class="o">*</span><span class="mf">0.0</span><span class="p">;</span>

    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Cx&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">cx</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">cy</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">cz</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

    <span class="n">libqints</span><span class="o">::</span><span class="n">basis_1e2c_cgto</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">b2i</span><span class="p">(</span><span class="n">aobasis</span><span class="p">.</span><span class="n">b1</span><span class="p">,</span> <span class="n">aobasis</span><span class="p">.</span><span class="n">b1</span><span class="p">);</span>


    <span class="n">libqints</span><span class="o">::</span><span class="n">dig_passthru_1e2c_cgto</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">3</span><span class="o">&gt;</span> <span class="n">dig</span><span class="p">(</span><span class="n">b2i</span><span class="p">,</span> <span class="n">ma_L</span><span class="p">);</span>
    <span class="n">libqints</span><span class="o">::</span><span class="n">op_angmomentum</span> <span class="n">L</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">cz</span><span class="p">);</span>
    <span class="c1">// libqints::qints_job qj(L, aobasis.b2, qints_dev);</span>
    <span class="n">libfock</span><span class="o">::</span><span class="n">make_angmommat</span><span class="p">(</span><span class="n">aobasis</span><span class="p">.</span><span class="n">b1</span><span class="p">,</span> <span class="n">aobasis</span><span class="p">.</span><span class="n">b1</span><span class="p">,</span> <span class="n">av_Lx</span><span class="p">,</span> <span class="n">av_Ly</span><span class="p">,</span> <span class="n">av_Lz</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">cz</span><span class="p">);</span>

    <span class="n">libqints</span><span class="o">::</span><span class="n">scr_null</span><span class="o">&lt;</span><span class="n">libqints</span><span class="o">::</span><span class="n">bat_1e2c_cgto</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">scr</span><span class="p">;</span>
    <span class="c1">//libqints::qints(L, b2i, scr, dig, qints_dev);</span>


    <span class="n">arma</span><span class="o">::</span><span class="n">Mat</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">arma_Lx</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Lx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">NBasis</span><span class="p">,</span> <span class="n">NBasis</span><span class="p">);</span>
    <span class="n">arma</span><span class="o">::</span><span class="n">Mat</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">arma_Ly</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Ly</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">NBasis</span><span class="p">,</span> <span class="n">NBasis</span><span class="p">);</span>
    <span class="n">arma</span><span class="o">::</span><span class="n">Mat</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">arma_Lz</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Lz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">NBasis</span><span class="p">,</span> <span class="n">NBasis</span><span class="p">);</span>

    <span class="c1">// Reorder to Q-Chem ordering</span>
    <span class="n">libqints</span><span class="o">::</span><span class="n">gto</span><span class="o">::</span><span class="n">reorder_cc</span><span class="p">(</span><span class="n">arma_Lx</span><span class="p">,</span> <span class="n">aobasis</span><span class="p">.</span><span class="n">b1</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">libqints</span><span class="o">::</span><span class="n">gto</span><span class="o">::</span><span class="n">lex</span><span class="p">,</span> <span class="n">libqints</span><span class="o">::</span><span class="n">gto</span><span class="o">::</span><span class="n">korder</span><span class="p">);</span>
    <span class="n">libqints</span><span class="o">::</span><span class="n">gto</span><span class="o">::</span><span class="n">reorder_cc</span><span class="p">(</span><span class="n">arma_Ly</span><span class="p">,</span> <span class="n">aobasis</span><span class="p">.</span><span class="n">b1</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">libqints</span><span class="o">::</span><span class="n">gto</span><span class="o">::</span><span class="n">lex</span><span class="p">,</span> <span class="n">libqints</span><span class="o">::</span><span class="n">gto</span><span class="o">::</span><span class="n">korder</span><span class="p">);</span>
    <span class="n">libqints</span><span class="o">::</span><span class="n">gto</span><span class="o">::</span><span class="n">reorder_cc</span><span class="p">(</span><span class="n">arma_Lz</span><span class="p">,</span> <span class="n">aobasis</span><span class="p">.</span><span class="n">b1</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">libqints</span><span class="o">::</span><span class="n">gto</span><span class="o">::</span><span class="n">lex</span><span class="p">,</span> <span class="n">libqints</span><span class="o">::</span><span class="n">gto</span><span class="o">::</span><span class="n">korder</span><span class="p">);</span>

    <span class="c1">// Explicitely antisymmetrize integrals to kill numeric noise...</span>
    <span class="n">arma_Lx</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">arma_Lx</span> <span class="o">-</span> <span class="n">arma_Lx</span><span class="p">.</span><span class="n">t</span><span class="p">());</span>
    <span class="n">arma_Ly</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">arma_Ly</span> <span class="o">-</span> <span class="n">arma_Ly</span><span class="p">.</span><span class="n">t</span><span class="p">());</span>
    <span class="n">arma_Lz</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">arma_Lz</span> <span class="o">-</span> <span class="n">arma_Lz</span><span class="p">.</span><span class="n">t</span><span class="p">());</span>

    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Lx&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">arma_Lx</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">arma</span><span class="o">::</span><span class="n">dot</span><span class="p">(</span><span class="n">arma_Lx</span><span class="p">,</span> <span class="n">P</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Ly&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">arma_Ly</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">arma</span><span class="o">::</span><span class="n">dot</span><span class="p">(</span><span class="n">arma_Ly</span><span class="p">,</span> <span class="n">P</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Lz&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">arma_Lz</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">arma</span><span class="o">::</span><span class="n">dot</span><span class="p">(</span><span class="n">arma_Lz</span><span class="p">,</span> <span class="n">P</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

    <span class="n">AngularMomentOperator</span> <span class="nf">angmom</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>

    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Lx2&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">angmom</span><span class="p">.</span><span class="n">get_matrix_ao</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">arma_Lx</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Ly2&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">angmom</span><span class="p">.</span><span class="n">get_matrix_ao</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">arma_Ly</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Lz2&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">angmom</span><span class="p">.</span><span class="n">get_matrix_ao</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">arma_Lz</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

<span class="p">}</span>

<span class="c1">// test function</span>
<span class="kt">void</span> <span class="n">fer_test</span><span class="p">()</span> <span class="p">{</span>

    <span class="kt">int</span> <span class="n">NB2Car</span> <span class="o">=</span> <span class="n">rem_read</span><span class="p">(</span><span class="n">REM_NB2CAR</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">NBas</span>   <span class="o">=</span> <span class="n">bSetMgr</span><span class="p">.</span><span class="n">crntShlsStats</span><span class="p">(</span><span class="n">STAT_NBASIS</span><span class="p">);</span>

    <span class="n">arma</span><span class="o">::</span><span class="n">vec</span> <span class="n">pdm1_v</span><span class="p">;</span>
    <span class="n">arma</span><span class="o">::</span><span class="n">vec</span> <span class="n">J_v</span><span class="p">;</span>

    <span class="n">arma</span><span class="o">::</span><span class="n">mat</span> <span class="n">pdm1</span><span class="p">;</span>
    <span class="n">arma</span><span class="o">::</span><span class="n">mat</span> <span class="n">pdm2</span><span class="p">;</span>
    <span class="n">arma</span><span class="o">::</span><span class="n">mat</span> <span class="n">J</span><span class="p">;</span>

    <span class="n">pdm1</span><span class="p">.</span><span class="n">set_size</span><span class="p">(</span><span class="n">NBas</span><span class="p">,</span> <span class="n">NBas</span><span class="p">);</span>
    <span class="n">pdm2</span><span class="p">.</span><span class="n">set_size</span><span class="p">(</span><span class="n">NBas</span><span class="p">,</span> <span class="n">NBas</span><span class="p">);</span>
    <span class="n">pdm1</span><span class="p">.</span><span class="n">zeros</span><span class="p">();</span>
    <span class="n">pdm2</span><span class="p">.</span><span class="n">zeros</span><span class="p">();</span>

    <span class="n">pdm1</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.523</span><span class="p">;</span>
    <span class="n">pdm1</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mf">-0.523</span><span class="p">;</span>
    <span class="n">pdm1</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
    <span class="n">pdm1</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>

    <span class="n">pdm2</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="mi">14</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.523</span><span class="p">;</span>
    <span class="n">pdm2</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="mi">19</span><span class="p">,</span><span class="mi">19</span><span class="p">)</span> <span class="o">=</span> <span class="mf">-0.523</span><span class="p">;</span>
    <span class="n">pdm2</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="mi">19</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
    <span class="n">pdm2</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="mi">19</span><span class="p">,</span><span class="mi">14</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>

    <span class="n">J</span><span class="p">.</span><span class="n">set_size</span><span class="p">(</span><span class="n">NBas</span><span class="p">,</span> <span class="n">NBas</span><span class="p">);</span>

    <span class="n">pdm1_v</span><span class="p">.</span><span class="n">set_size</span><span class="p">(</span><span class="n">NB2Car</span><span class="p">);</span>
    <span class="n">J_v</span><span class="p">.</span><span class="n">set_size</span><span class="p">(</span><span class="n">NB2Car</span><span class="p">);</span>

    <span class="n">ScaV2M</span><span class="p">(</span><span class="n">pdm1</span><span class="p">.</span><span class="n">memptr</span><span class="p">(),</span> <span class="n">pdm1_v</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

    <span class="n">AOIntsJobInfo</span> <span class="nf">JobInfo</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="n">TenMin</span><span class="p">(</span><span class="n">rem_read</span><span class="p">(</span><span class="n">REM_ITHRSH</span><span class="p">)));</span>
    <span class="c1">//JobInfo.TurnIntScreenOn();</span>
    <span class="n">ShlPrs</span> <span class="nf">s2Bra</span><span class="p">(</span><span class="n">DEF_ID</span><span class="p">);</span>

    <span class="n">AOints</span><span class="p">(</span><span class="n">J_v</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="n">pdm1_v</span><span class="p">.</span><span class="n">memptr</span><span class="p">(),</span>
           <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">JobInfo</span><span class="p">,</span> <span class="n">s2Bra</span><span class="p">,</span> <span class="n">s2Bra</span><span class="p">);</span>


    <span class="n">ScaV2M</span><span class="p">(</span><span class="n">J</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">J_v</span><span class="p">.</span><span class="n">memptr</span><span class="p">(),</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;J: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">J</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;energy test: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">arma</span><span class="o">::</span><span class="n">accu</span><span class="p">(</span><span class="n">pdm2</span> <span class="o">%</span> <span class="n">J</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; : &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">arma</span><span class="o">::</span><span class="n">accu</span><span class="p">(</span><span class="n">pdm2</span> <span class="o">%</span> <span class="n">J</span><span class="p">)</span> <span class="o">*</span> <span class="n">ConvFac</span><span class="p">(</span><span class="n">HARTREES_TO_EV</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>

    <span class="n">MultipoleMomentOperator</span> <span class="nf">mp</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
    <span class="kt">double</span> <span class="n">dp1</span> <span class="o">=</span> <span class="o">-</span><span class="n">arma</span><span class="o">::</span><span class="n">accu</span><span class="p">(</span><span class="n">pdm1</span> <span class="o">%</span> <span class="n">mp</span><span class="p">.</span><span class="n">get_quadrupole_matrix</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
    <span class="kt">double</span> <span class="n">dp2</span> <span class="o">=</span> <span class="o">-</span><span class="n">arma</span><span class="o">::</span><span class="n">accu</span><span class="p">(</span><span class="n">pdm1</span> <span class="o">%</span> <span class="n">mp</span><span class="p">.</span><span class="n">get_quadrupole_matrix</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
    <span class="kt">double</span> <span class="n">dp3</span> <span class="o">=</span> <span class="o">-</span><span class="n">arma</span><span class="o">::</span><span class="n">accu</span><span class="p">(</span><span class="n">pdm1</span> <span class="o">%</span> <span class="n">mp</span><span class="p">.</span><span class="n">get_quadrupole_matrix</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;dipole1 &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">dp1</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span><span class="o">&lt;&lt;</span> <span class="n">dp2</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">dp3</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>

    <span class="n">dp1</span> <span class="o">=</span> <span class="o">-</span><span class="n">arma</span><span class="o">::</span><span class="n">accu</span><span class="p">(</span><span class="n">pdm2</span> <span class="o">%</span> <span class="n">mp</span><span class="p">.</span><span class="n">get_quadrupole_matrix</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
    <span class="n">dp2</span> <span class="o">=</span> <span class="o">-</span><span class="n">arma</span><span class="o">::</span><span class="n">accu</span><span class="p">(</span><span class="n">pdm2</span> <span class="o">%</span> <span class="n">mp</span><span class="p">.</span><span class="n">get_quadrupole_matrix</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
    <span class="n">dp3</span> <span class="o">=</span> <span class="o">-</span><span class="n">arma</span><span class="o">::</span><span class="n">accu</span><span class="p">(</span><span class="n">pdm2</span> <span class="o">%</span> <span class="n">mp</span><span class="p">.</span><span class="n">get_quadrupole_matrix</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;dipole2 &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">dp1</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span><span class="o">&lt;&lt;</span> <span class="n">dp2</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">dp3</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>

    <span class="n">MultipoleMomentOperator</span> <span class="nf">mp2</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
    <span class="n">DensityMatrix</span> <span class="n">pdm1_gs</span><span class="p">;</span> <span class="c1">// HF density</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;quadrupole: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">mp2</span><span class="p">.</span><span class="n">get_quadrupole_moment</span><span class="p">(</span><span class="n">pdm1_gs</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>

<span class="p">}</span>
</pre></div>
</div>
</div>
</div>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h4>Previous topic</h4>
  <p class="topless"><a href="math.html"
                        title="previous chapter">How to write in reStructuredText</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="gromacs.html"
                        title="next chapter">GROMACS</a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="gromacs.html" title="GROMACS"
             >next</a> |</li>
        <li class="right" >
          <a href="math.html" title="How to write in reStructuredText"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">wiki  documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Development Q-Chem</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2019, Abel Carreras.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.4.0.
    </div>
  </body>
</html>